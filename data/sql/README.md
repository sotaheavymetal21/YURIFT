# ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´

YURIFTãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´å±¥æ­´ã§ã™ã€‚

---

## ğŸ“‹ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå±¥æ­´

| # | ãƒ•ã‚¡ã‚¤ãƒ« | å®Ÿè¡Œæ—¥ | èª¬æ˜ | å®Ÿè¡Œè€… | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|---|---------|-------|------|-------|----------|
| 01 | `01_create_onsen_master.sql` | æœªå®Ÿè¡Œ | æ¸©æ³‰ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | - | ğŸŸ¡ Pending |
| 02 | `02_create_search_cache.sql` | æœªå®Ÿè¡Œ | æ¤œç´¢ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ | - | ğŸŸ¡ Pending |
| 03 | `03_sample_data.sql` | æœªå®Ÿè¡Œ | ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼ˆé–‹ç™ºç”¨ï¼‰ | - | ğŸŸ¡ Pending |

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**:
- ğŸŸ¢ **Applied**: å®Ÿè¡Œæ¸ˆã¿
- ğŸŸ¡ **Pending**: æœªå®Ÿè¡Œï¼ˆåˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã«å®Ÿè¡Œï¼‰
- ğŸ”´ **Rolled Back**: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¸ˆã¿

---

## ğŸ—„ï¸ ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒ

### ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ«å | èª¬æ˜ | ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ï¼ˆæƒ³å®šï¼‰ |
|-----------|------|------------------|
| `onsen_master` | æ—¥å¸°ã‚Šæ¸©æ³‰æ–½è¨­ãƒã‚¹ã‚¿ãƒ¼ | 100ã€œ1000ä»¶ |
| `search_cache` | Driftæ¤œç´¢çµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥ | å¯å¤‰ï¼ˆTTL: 7æ—¥ï¼‰ |

### ERå›³ï¼ˆç°¡æ˜“ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   onsen_master      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)             â”‚
â”‚ name                â”‚
â”‚ address             â”‚
â”‚ lat                 â”‚
â”‚ lng                 â”‚
â”‚ price               â”‚
â”‚ keywords (array)    â”‚
â”‚ created_at          â”‚
â”‚ updated_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   search_cache      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cache_key (PK)      â”‚
â”‚ search_params (JSON)â”‚
â”‚ result (JSON)       â”‚
â”‚ created_at          â”‚
â”‚ expires_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ‰‹é †

### åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
# 1. Supabase SQL Editorã«ã‚¢ã‚¯ã‚»ã‚¹
# https://app.supabase.com/project/{project_id}/sql

# 2. ä»¥ä¸‹ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †ç•ªã«å®Ÿè¡Œ
# - 01_create_onsen_master.sql
# - 02_create_search_cache.sql
# - 03_sample_data.sqlï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰

# 3. å®Ÿè¡Œå¾Œã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã€Œãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå±¥æ­´ã€ã‚’æ›´æ–°
```

### æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹å ´åˆ

```bash
# 1. æ–°ã—ã„SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
touch data/sql/04_add_new_feature.sql

# 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨˜è¿°
cat > data/sql/04_add_new_feature.sql << 'EOF'
-- ============================================
-- Migration: 04_add_new_feature
-- Date: 2026-01-XX
-- Author: @yourname
-- Description: æ–°æ©Ÿèƒ½ã®èª¬æ˜
-- Rollback: 04_rollback_add_new_feature.sql
-- ============================================

-- SQLæ–‡ã‚’ã“ã“ã«è¨˜è¿°
EOF

# 3. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨SQLã‚‚ä½œæˆ
touch data/sql/04_rollback_add_new_feature.sql

# 4. Supabase SQL Editorã§å®Ÿè¡Œ

# 5. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 

# 6. Gitã‚³ãƒŸãƒƒãƒˆ
git add data/sql/04_*.sql
git add data/sql/README.md
git commit -m "Add migration: 04_add_new_feature"
```

---

## ğŸ“ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°

### 01_create_onsen_master.sql

**ç›®çš„**: æ—¥å¸°ã‚Šæ¸©æ³‰æ–½è¨­ã®åŸºæœ¬æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ãƒã‚¹ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«

**ä¸»è¦ã‚«ãƒ©ãƒ **:
- `id`: æ–½è¨­IDï¼ˆè‡ªå‹•æ¡ç•ªï¼‰
- `name`: æ–½è¨­å
- `address`: ä½æ‰€
- `lat`, `lng`: ç·¯åº¦ãƒ»çµŒåº¦ï¼ˆè·é›¢è¨ˆç®—ç”¨ï¼‰
- `price`: æ–™é‡‘ï¼ˆå††ï¼‰
- `keywords`: æ¤œç´¢ç”¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é…åˆ—

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_onsen_location`: ä½ç½®æƒ…å ±æ¤œç´¢ã®é«˜é€ŸåŒ–
- `idx_onsen_keywords`: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã®é«˜é€ŸåŒ–ï¼ˆGINï¼‰
- `idx_onsen_price`: æ–™é‡‘ã‚½ãƒ¼ãƒˆã®é«˜é€ŸåŒ–

**ãƒˆãƒªã‚¬ãƒ¼**:
- `update_onsen_master_updated_at`: æ›´æ–°æ—¥æ™‚è‡ªå‹•æ›´æ–°

---

### 02_create_search_cache.sql

**ç›®çš„**: Driftæ¤œç´¢çµæœã‚’7æ—¥é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦OpenAI APIã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›

**ä¸»è¦ã‚«ãƒ©ãƒ **:
- `cache_key`: æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒƒã‚·ãƒ¥å€¤ï¼ˆPKï¼‰
- `search_params`: æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆJSONï¼‰
- `result`: æ¤œç´¢çµæœï¼ˆJSONï¼‰
- `expires_at`: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æœŸé™

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:
- `idx_cache_expires`: æœŸé™åˆ‡ã‚Œã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å‰Šé™¤ç”¨
- `idx_cache_params`: æ¤œç´¢ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ¤œç´¢ç”¨ï¼ˆGINï¼‰

**RLSãƒãƒªã‚·ãƒ¼**:
- `cache_valid_reads`: æœŸé™åˆ‡ã‚Œãƒ‡ãƒ¼ã‚¿ã¯èª­ã¿å–ã‚Šä¸å¯
- `cache_insert`: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ¿å…¥å¯èƒ½

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**:
- TTL: 7æ—¥é–“
- æœŸé™åˆ‡ã‚Œãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«èª­ã¿å–ã‚Šä¸å¯ï¼ˆRLSï¼‰
- å®šæœŸçš„ã«ãƒã‚­ãƒ¥ãƒ¼ãƒ ï¼ˆSupabaseè‡ªå‹•ï¼‰

---

### 03_sample_data.sql

**ç›®çš„**: é–‹ç™ºç’°å¢ƒç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

**ãƒ‡ãƒ¼ã‚¿å†…å®¹**:
- é¦–éƒ½åœã®æ—¥å¸°ã‚Šæ¸©æ³‰æ–½è¨­ 15ä»¶
- å„æ–½è¨­ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¨­å®šæ¸ˆã¿
- ç·¯åº¦ãƒ»çµŒåº¦è¨­å®šæ¸ˆã¿

**æ³¨æ„**:
- æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿè¡Œã—ãªã„
- é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®ã¿

---

## ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å±¥æ­´

ç¾åœ¨ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãŸå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

---

## ğŸ“Š çµ±è¨ˆæƒ…å ±

**æœ€çµ‚æ›´æ–°æ—¥**: 2026-01-02
**ç·ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°**: 3
**é©ç”¨æ¸ˆã¿**: 0
**æœªé©ç”¨**: 3

---

## ğŸ”® ä»Šå¾Œã®äºˆå®š

### Phase 1: MVPï¼ˆç¾åœ¨ï¼‰
- [x] åŸºæœ¬ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆï¼ˆ`onsen_master`, `search_cache`ï¼‰
- [ ] åˆå›ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŠ•å…¥

### Phase 2: æ©Ÿèƒ½æ‹¡å¼µ
- [ ] `reviews` ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
- [ ] `favorites` ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ï¼‰
- [ ] `search_history` ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆæ¤œç´¢å±¥æ­´ï¼‰

### Phase 3: ã‚¹ã‚±ãƒ¼ãƒ«
- [ ] PostGISå°å…¥ï¼ˆè·é›¢æ¤œç´¢é«˜é€ŸåŒ–ï¼‰
- [ ] ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æ¤œè¨ï¼ˆsearch_cacheï¼‰
- [ ] Supabase CLI Migration ã¸ã®ç§»è¡Œ

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰**: [../MIGRATION_GUIDE.md](../MIGRATION_GUIDE.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸**: [../../docs/ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸_è¶…ä½ã‚³ã‚¹ãƒˆç‰ˆ.md](../../docs/ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸_è¶…ä½ã‚³ã‚¹ãƒˆç‰ˆ.md)
- **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰**: [../../SETUP.md](../../SETUP.md)

---

## ğŸ¤ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã®æ³¨æ„äº‹é …

### é–‹ç™ºç’°å¢ƒ
- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆ03_sample_data.sqlï¼‰ã‚’æŠ•å…¥ã—ã¦OK
- ä½•åº¦ã§ã‚‚ãƒªã‚»ãƒƒãƒˆå¯èƒ½

### æœ¬ç•ªç’°å¢ƒ
- **å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—**
- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯æŠ•å…¥ã—ãªã„
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã«ãƒãƒ¼ãƒ å…¨ä½“ã«é€šçŸ¥
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯SQLã‚’æº–å‚™

---

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå¾Œã¯ã€å¿…ãšã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚**
