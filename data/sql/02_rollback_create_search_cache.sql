-- ============================================
-- Rollback Migration: 02_rollback_create_search_cache
-- Date: 2026-01-02
-- Author: @yurift
-- Description: Rollback for 02_create_search_cache.sql
-- Original Migration: 02_create_search_cache.sql
-- ============================================

-- âš ï¸ WARNING: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™
-- å®Ÿè¡Œå¾Œã€æ¤œç´¢æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ãŒç™ºç”Ÿã—OpenAI APIå‘¼ã³å‡ºã—ãŒå¢—åŠ ã—ã¾ã™

-- â–¼â–¼â–¼ Rollback Start â–¼â–¼â–¼

-- ========================================
-- 1. RLSãƒãƒªã‚·ãƒ¼å‰Šé™¤
-- ========================================

DROP POLICY IF EXISTS cache_valid_reads ON search_cache;
DROP POLICY IF EXISTS cache_insert ON search_cache;

-- ========================================
-- 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‰Šé™¤
-- ========================================

DROP INDEX IF EXISTS idx_cache_expires;
DROP INDEX IF EXISTS idx_cache_params;

-- ========================================
-- 3. ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤
-- ========================================

DROP TABLE IF EXISTS search_cache CASCADE;

-- âš ï¸ search_cache ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™

-- â–²â–²â–² Rollback End â–²â–²â–²

-- ============================================
-- Verification (å®Ÿè¡Œå¾Œã®ç¢ºèªç”¨ã‚¯ã‚¨ãƒª)
-- ============================================

-- ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå‰Šé™¤ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªï¼ˆfalse ãŒè¿”ã‚‹ã¯ãšï¼‰
SELECT EXISTS (
    SELECT FROM information_schema.tables
    WHERE table_schema = 'public'
    AND table_name = 'search_cache'
) as table_exists;

-- RLSãƒãƒªã‚·ãƒ¼ãŒå‰Šé™¤ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªï¼ˆ0ä»¶ã®ã¯ãšï¼‰
SELECT COUNT(*) as policy_count
FROM pg_policies
WHERE tablename = 'search_cache';

-- ============================================
-- Rollbackå®Œäº†å¾Œã®æ‰‹é †
-- ============================================
-- 1. data/sql/README.md ã®å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
-- 2. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ "ğŸ”´ Rolled Back" ã«å¤‰æ›´
-- 3. Gitã‚³ãƒŸãƒƒãƒˆ
--    git add data/sql/02_rollback_create_search_cache.sql
--    git add data/sql/README.md
--    git commit -m "Rollback: search_cache table"
-- 4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•å¾Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå†æ§‹ç¯‰ã•ã‚Œã¾ã™
-- ============================================

-- ============================================
-- Notes
-- ============================================
-- - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿æå¤±ã®å½±éŸ¿ã¯é™å®šçš„
-- - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã€æ¤œç´¢æ™‚ã®OpenAI APIå‘¼ã³å‡ºã—ãŒä¸€æ™‚çš„ã«å¢—åŠ 
-- - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯è‡ªå‹•çš„ã«å†æ§‹ç¯‰ã•ã‚Œã¾ã™ï¼ˆTTL: 7æ—¥é–“ï¼‰
-- ============================================
